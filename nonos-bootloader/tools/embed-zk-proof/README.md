```
                    ##    ##   ######   ##    ##   ######    ######
                    ###   ##  ##    ##  ###   ##  ##    ##  ##    ##
                    ####  ##  ##    ##  ####  ##  ##    ##  ##
                    ## ## ##  ##    ##  ## ## ##  ##    ##   ######
                    ##  ####  ##    ##  ##  ####  ##    ##        ##
                    ##   ###  ##    ##  ##   ###  ##    ##  ##    ##
                    ##    ##   ######   ##    ##   ######    ######

        ########  ##     ##  ########   ########  ########          ########  ##    ##
        ##        ###   ###  ##     ##  ##        ##     ##              ##   ##   ##
        ##        #### ####  ##     ##  ##        ##     ##             ##    ##  ##
        ######    ## ### ##  ########   ######    ##     ##   ######   ##     #####
        ##        ##     ##  ##     ##  ##        ##     ##           ##      ##  ##
        ##        ##     ##  ##     ##  ##        ##     ##          ##       ##   ##
        ########  ##     ##  ########   ########  ########          ########  ##    ##

                        ########   ########    ######    ######   ########
                        ##     ##  ##     ##  ##    ##  ##    ##  ##
                        ##     ##  ##     ##  ##    ##  ##    ##  ##
                        ########   ########   ##    ##  ##    ##  ######
                        ##         ##   ##    ##    ##  ##    ##  ##
                        ##         ##    ##   ##    ##  ##    ##  ##
                        ##         ##     ##   ######    ######   ##
```

# embed-zk-proof

Groth16 zero-knowledge proof embedder for the NØNOS boot attestation chain.

---

## What This Tool Does

After a kernel is signed with Ed25519, it needs one more thing before the bootloader will accept it: a zero-knowledge attestation proof. This tool takes that proof and embeds it into the signed kernel binary in a structured format the bootloader knows how to parse and verify.

The proof block contains a magic header, the program hash identifying which circuit generated the proof, a capsule commitment binding the public inputs, and the 192-byte Groth16 proof itself. When the bootloader runs, it locates this block by scanning for the magic bytes, extracts the proof, and verifies it against the embedded verifying key. If verification fails, the machine resets. No exceptions.

---

## Building

From this directory:

```
cargo build --release
```

The binary lands at `target/release/embed-zk-proof`.

---

## Embedding a Proof

The typical workflow starts with a signed kernel and a proof file generated by the attestation circuit:

```
./target/release/embed-zk-proof \
  --input kernel_signed.bin \
  --output kernel_attested.bin \
  --proof attestation_proof.bin \
  --program-id "nonos-boot-attest-v1" \
  --public-inputs public_inputs.bin
```

This reads the signed kernel, appends the ZK proof block, and writes the final attested kernel. The `--program-id` gets hashed with BLAKE3 using domain separation to produce the program hash. If you already have a precomputed program hash, pass it directly:

```
./target/release/embed-zk-proof \
  --input kernel_signed.bin \
  --output kernel_attested.bin \
  --proof attestation_proof.bin \
  --program-hash a1b2c3d4e5f6...
```

The public inputs file is optional. If omitted, the tool uses empty public inputs and computes the capsule commitment accordingly.

---

## Command Line Reference

`--input` or `-i` is the signed kernel binary (must already have Ed25519 signature appended).

`--output` or `-o` is the destination path for the attested kernel.

`--proof` or `-p` is the 192-byte Groth16 proof file.

`--program-id` is the human-readable program identifier, hashed to produce the program hash.

`--program-hash` is the raw 32-byte program hash as hex (alternative to `--program-id`).

`--public-inputs` is the file containing public circuit inputs, must be 32-byte aligned.

`--verbose` or `-v` prints detailed header information for debugging.

---

## ZK Proof Block Format

The embedded block has a fixed structure that the bootloader parses at verification time:

```
Offset  Size  Field
------  ----  -----
0       4     Magic bytes: 0x4E 0xC3 0x5A 0x50
4       4     Version (little-endian u32, currently 1)
8       32    Program hash (BLAKE3 derive_key)
40      32    Capsule commitment (BLAKE3 derive_key)
72      4     Public inputs length (little-endian u32)
76      4     Proof blob length (little-endian u32)
80      var   Public inputs (32-byte aligned)
80+n    192   Groth16 proof (compressed BLS12-381)
```

The magic bytes were chosen to be unlikely to appear in normal ELF code. The bootloader scans backward from the end of the kernel looking for this signature.

---

## Domain Separation

All hashing uses BLAKE3 with domain separation to prevent cross-protocol attacks:

The program hash uses domain `NONOS:ZK:PROGRAM:v1`. Given a program identifier like `nonos-boot-attest-v1`, the hash is computed as:

```
BLAKE3_derive_key("NONOS:ZK:PROGRAM:v1", "nonos-boot-attest-v1")
```

The capsule commitment uses domain `NONOS:CAPSULE:COMMITMENT:v1`, binding the public inputs to the proof.

---

## Output Structure

After embedding, the kernel binary has three sections:

```
# ELF Kernel Code | Variable size

# Key signature
Ed25519 Signature (64 bytes)

# ZK Proof Block to 272+ bytes
- Magic: 0x4E 0xC3 0x5A 0x50  
- Program Hash (32 bytes)      
- Capsule Commitment (32 bytes) 
- Public Inputs     
- Groth16 Proof (192 bytes)     
```

The bootloader verifies the Ed25519 signature first, then locates and verifies the ZK proof. Both must pass.

---

## Integration

This tool sits at the end of the attestation pipeline:

1. **keygen** generates the Ed25519 signing keypair
2. **sign-kernel** signs the compiled kernel
3. **generate-proof** creates the Groth16 attestation proof
4. **embed-zk-proof** combines everything into the final binary

A typical build script runs:

```
# Sign the kernel
../sign-kernel/target/release/nonos-sign-kernel \
  --key ../../keys/signing_key_v1.bin \
  --input kernel.bin \
  --output kernel_signed.bin

# Generate the proof
../nonos-attestation-circuit/target/release/generate-proof \
  --proving-key ./attestation_proving_key.bin \
  --output proof.bin \
  --public-inputs-out public_inputs.bin

# Embed the proof
./target/release/embed-zk-proof \
  --input kernel_signed.bin \
  --output kernel_attested.bin \
  --proof proof.bin \
  --program-id "nonos-boot-attest-v1" \
  --public-inputs public_inputs.bin
```

The `kernel_attested.bin` file is what goes on the EFI System Partition.

---

## Validation

The tool performs several checks before embedding:

- Signed kernel must be at least 128 bytes (room for ELF header + signature)
- Proof file must be exactly 192 bytes (Groth16 compressed size)
- Public inputs must be 32-byte aligned (field element size)
- Either `--program-id` or `--program-hash` must be provided

If any check fails, the tool aborts with a clear error message. No malformed kernels get written.

---

## Verbose Output

Pass `--verbose` to see the full header breakdown:

```
=== ZK Block Header ===
  Magic:             [4E, C3, 5A, 50]
  Version:           1
  Program Hash:      a1b2c3d4e5f6...
  Commitment:        f6e5d4c3b2a1...
  Public Inputs Len: 64
  Proof Blob Len:    192
```

This helps debug issues where the bootloader fails to verify.

---

## Dependencies

The tool deliberately avoids arkworks dependencies since it doesn't verify proofs—it just packages them. The only cryptographic operation is BLAKE3 hashing for program hash derivation and capsule commitment computation.

- `blake3` 1.5 for hashing
- `clap` 4.0 for CLI parsing
- `anyhow` for error handling
- `hex` for encoding

---

## License

AGPL-3.0-or-later

Copyright 2026 NØNOS Contributors
